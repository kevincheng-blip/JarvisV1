# 股市聖經三：頂尖量化系統架構與實作指南

## 這本書的目的

本文件旨在將 J-GOD 股神作戰系統提升至 Citadel（市場控制力）與 Renaissance Medallion（報酬率）等級的量化交易系統。透過系統化的架構設計、五因子模型、強化學習自主演化機制，以及 Citadel 風格的預測性風控，建立一個具備工業級韌性的 AI 驅動交易系統。

**核心目標**：
- 建立可程式化、可學習、可演化的量化交易系統
- 整合微觀交易行為、跨市場結構、循環、風格、動能五大因子
- 實現預測性風控與智能執行，降低滑價並提升 Sharpe Ratio
- 設計自主演化機制，讓系統持續優化因子權重與執行策略

---

## 核心投資邏輯

### 一、頂尖機構的核心優勢分析

#### 1. Citadel 的市場控制力
- **核心理念**：不只是預測方向，更是掌控「誰在出手、何時出手、願意接受什麼價格」
- **關鍵能力**：
  - 市場流動性提供者，下單決策本身控制滑價
  - 市場衝擊模型：精確計算訂單對未來 10 毫秒內價格的影響
  - 微觀結構 TCA：實時監控訂單簿變化，估計市場願意承受的衝擊
  - 經紀商行為指紋：從分點行為推測主力下一步

#### 2. Renaissance Medallion 的統計套利
- **核心理念**：不關心股票會漲到哪裡，只關心「價格在下一秒會如何修復它當前的統計錯誤」
- **關鍵能力**：
  - 高維非線性模型：預測兩個資產之間價差的短期均值回歸
  - 因子交叉項：同時觀察數百個因子，重視因子之間的交互作用
  - 價格的物理屬性：一階導數（速度）、二階導數（加速度）、熵（不確定度）
  - 跨資產流動性傳染：偵測期貨、ETF 異常對現貨的傳導

### 二、J-GOD 五因子模型架構

#### 因子定義

**F_C（Cycle：景氣循環 / 大盤環境）**
- 景氣方向
- 利率趨勢
- 大盤的多空周期
- 長線主流（多頭還是空頭）

**F_S（Style：市場風格 / 資金流）**
- 小型股行情 vs 大型權值
- 電子 vs 金融 vs 傳產
- 哪些類股被「資金選擇」

**F_D（Drive：主題動能 / 產業故事）**
- AI、車用、IC 設計、生技、軍工、高股息
- 「什麼故事在熱，資金會往哪裡跑」

**F_Stat（微觀交易行為因子）**
- VWAP 偏離：價格 > VWAP 且乖離擴大 → 多方主導
- 異常量能：當前量 / 過去5～20筆平均量
- 攻擊型委託：市價單 > 限價單 → 多空其中一方「用力打」
- 委託簿壓力：Buy Size – Sell Size
- 價差變化：Spread 收斂 → 越來越多人想進場
- 微結構反轉訊號：多根小黑突然跳大紅 = 多頭攻擊

**F_Exec（跨市場執行因子）**
- 台指期 / 小台領先：現股還沒動，但期貨先向上突破
- 選擇權部位：Delta / Gamma / Put-Call 比率
- 台灣 50 / 電子期 / 金融期：提前看到板塊輪動
- 國際盤領先性：美股期貨 → 台股開盤
- ETF 資金流：外資買超的 ETF 對應標的提前熱度

#### 五因子整合邏輯

```
微觀（F_Stat）→ 盤中的力道、攻防、量價語言
跨市場（F_Exec）→ 期貨、ETF、美股的領先訊號
循環（F_C）→ 大盤環境與景氣方向
風格（F_S）→ 資金偏好與板塊輪動
動能（F_D）→ 主題熱度與題材強弱
```

**判斷規則**：
- 如果 F_Stat 強烈偏多 且 F_Exec 期貨領先向上 且 F_C 大盤多頭，則 強烈做多
- 如果 F_Stat 偏空 且 F_Exec 選擇權大量賣權 且 F_C 大盤空頭，則 強烈做空
- 如果 F_D 主題熱度高 且 F_S 資金流向該板塊，則 優先選擇該板塊標的

### 三、升級路徑

#### 優先階段：交易執行優化（向 Citadel 靠攏）
- 更聰明的切單策略
- 交易成本預測
- 基於盤中心理的下單節奏調整
- **目標**：直接拉高實戰 Sharpe Ratio

#### 中期階段：因子交叉與非線性模型（向 Medallion 靠攏）
- 從線性因子 → 升級成能學習 F_C × F_S × F_D × F_Stat × F_Exec 的高維交互作用
- 使用 DNN / Transformer 類架構，自動發現隱藏的非線性關係
- **目標**：讓模型自己長出「看不見的交叉 Alpha」

#### 長期階段：統計套利與均值回歸引擎
- 建立專門的「價差均值回歸引擎」
- 股票對 / 指數 vs ETF / 同產業籃子
- 做多被錯殺、放空被高估
- **目標**：建立獨立 Alpha 線，與方向交易不相關

---

## 股票判斷方法

### 一、技術面判斷

#### 1. 微觀交易行為判斷（F_Stat）

**VWAP 偏離判斷**
- 如果 價格 > VWAP 且 乖離擴大，則 多方主導
- 如果 價格 < VWAP 且 乖離擴大，則 空方主導
- 用於判斷短線方向與壓力

**異常量能判斷**
- 計算：當前量 / 過去5～20筆平均量
- 如果 量能爆出（> 2倍），則 趨勢啟動或反轉的早期訊號

**攻擊型委託判斷**
- 如果 市價單 > 限價單，則 多空其中一方「用力打」
- 判斷買賣力道是否倒向（真突破 vs 假突破）

**委託簿壓力判斷**
- 計算：Buy Size – Sell Size
- 如果 大買掛，則 下方撐
- 如果 大賣掛，則 上方壓

**價差變化判斷**
- 如果 Spread 收斂，則 越來越多人想進場
- 如果 Spread 擴大，則 趨勢不健康，市場避險

**微結構反轉訊號**
- 如果 多根小黑突然跳大紅，則 多頭攻擊
- 如果 多根小紅突然跳大黑，則 空頭反擊

#### 2. 跨市場領先判斷（F_Exec）

**期貨領先判斷**
- 如果 現股還沒動 且 期貨先向上突破，則 現股後續會漲
- 如果 現股還沒動 且 期貨先向下突破，則 現股後續會跌
- **規則**：台股 70% 時間都是期貨領先現股

**選擇權部位判斷**
- 如果 大量買權，則 預期上漲
- 如果 大量賣權，則 預期下跌
- 如果 Gamma 壓縮，則 當天震盪會變大、容易被甩

**國際盤領先判斷**
- 如果 美股期貨開盤前狂跌/狂漲，則 台股開盤跟著跑
- NASDAQ → 電子股
- S&P → 全市場
- VIX → 恐慌程度

#### 3. 籌碼成本判斷（F_C）

**LAC 偏離度計算**
- LAC（流動性加權平均成本）= 累積成本 / 累積交易量
- LAC_Deviation = 當前價格 - LAC
- 如果 LAC_Deviation > 2.0（Z-score），則 股價遠高於平均成本，獲利出貨警報
- 如果 LAC_Deviation < -2.0（Z-score），則 股價遠低於平均成本，集中套牢，技術性反彈或低吸機會

**計算公式**：
```
TP = (High + Low + Close) / 3
Cost_Weighted_Volume = TP × Volume
LAC = Sum(Cost_Weighted_Volume) / Sum(Volume)
LAC_Deviation = Close_Price - LAC
FC_LAC_Zscore = (LAC_Deviation - Mean) / Std
```

### 二、基本面判斷

#### 1. 市場風格判斷（F_S）

**資金流向判斷**
- 如果 小型股成交量佔比上升，則 小型股行情
- 如果 大型權值成交量佔比上升，則 大型權值行情
- 如果 電子類股成交量佔比上升，則 電子行情
- 如果 金融類股成交量佔比上升，則 金融行情

**市場結構熵判斷**
- 計算：所有股票成交量分佈的香農熵
- 如果 熵值低（資金集中），則 容易形成泡沫或短期趨勢
- 如果 熵值高（資金分散），則 市場情緒分散且缺乏方向性

**計算公式**：
```
Volume_Ratio = Volume_i / Total_Market_Volume
Entropy = -Σ(Volume_Ratio × log(Volume_Ratio))
```

#### 2. 主題動能判斷（F_D）

**主題熱度判斷**
- 如果 AI 相關股票集體上漲，則 AI 主題熱度高
- 如果 車用相關股票集體上漲，則 車用主題熱度高
- 如果 生技相關股票集體上漲，則 生技主題熱度高

**資金選擇判斷**
- 如果 某主題 ETF 資金流入，則 對應標的會有提前熱度
- 如果 某主題新聞熱度上升，則 資金會往該主題跑

### 三、綜合判斷邏輯

**多因子共振判斷**
- 如果 F_Stat 強烈偏多 且 F_Exec 期貨領先向上 且 F_C 大盤多頭 且 F_S 資金流向該板塊 且 F_D 主題熱度高，則 **強烈做多**
- 如果 F_Stat 偏空 且 F_Exec 選擇權大量賣權 且 F_C 大盤空頭，則 **強烈做空**
- 如果 F_C 籌碼集中獲利（LAC_Deviation > 2.0） 且 F_S 極度樂觀情緒，則 **主力準備出貨，而非繼續上攻**

---

## 交易策略

### 一、長線策略（基於 F_C, F_S, F_D）

#### 1. 籌碼集中策略
- **進場條件**：
  - 如果 LAC_Deviation < -2.0（Z-score） 且 F_S 資金開始流入 且 F_D 主題熱度上升，則 進場做多
- **出場條件**：
  - 如果 LAC_Deviation > 2.0（Z-score） 或 F_S 資金開始流出，則 出場
- **停損條件**：
  - 如果 價格跌破 LAC - 3.0 × Std，則 停損

#### 2. 主題動能策略
- **進場條件**：
  - 如果 F_D 主題熱度高 且 F_S 資金流向該主題 且 F_Exec ETF 資金流入，則 進場做多
- **出場條件**：
  - 如果 F_D 主題熱度下降 或 F_S 資金開始流出，則 出場
- **停損條件**：
  - 如果 價格跌破進場價 - 5%，則 停損

### 二、短線策略（基於 F_Stat, F_Exec）

#### 1. 盤中突破策略
- **進場條件**：
  - 如果 F_Stat VWAP 偏離擴大 且 異常量能爆發 且 F_Exec 期貨領先向上，則 進場做多
- **出場條件**：
  - 如果 F_Stat 微結構反轉訊號出現（多根小紅跳大黑），則 出場
- **停損條件**：
  - 如果 價格跌破進場價 - 2%，則 停損

#### 2. 跨市場套利策略
- **進場條件**：
  - 如果 F_Exec 期現 Basis 異常（深度貼水或高度溢價） 且 F_Exec 跨市場 Beta 殘差異常，則 進場套利
- **出場條件**：
  - 如果 Basis 回歸正常範圍，則 出場
- **停損條件**：
  - 如果 Basis 繼續擴大超過 3 倍標準差，則 停損

### 三、統計套利策略（Medallion 風格）

#### 1. 配對交易
- **進場條件**：
  - 如果 兩個高度相關資產的價差 Z-score > 2.0，則 做多被錯殺、做空被高估
- **出場條件**：
  - 如果 價差 Z-score 回歸到 0，則 出場
- **停損條件**：
  - 如果 價差 Z-score 繼續擴大超過 3.0，則 停損

### 四、AI 補充策略

#### 1. 因子交叉策略
- **進場條件**：
  - 如果 (F_C × F_S) 交叉項強烈偏多 且 (F_Stat × F_Exec) 交叉項強烈偏多，則 進場做多
- **邏輯**：利用高維非線性模型自動發現因子交叉關係

#### 2. 市場狀態適應策略
- **如果 市場狀態 = 趨勢**，則 使用動能策略
- **如果 市場狀態 = 震盪**，則 使用均值回歸策略
- **如果 市場狀態 = 狂潮**，則 降低倉位或退出

---

## 風險控管與心理面

### 一、預測性風控（Citadel 風格）

#### 1. 交易成本預測（TCA）

**計算邏輯**：
- 根據當前五檔報價深度和訂單量，預測執行這筆訂單的平均滑價成本
- 如果 預測滑價 > RL 允許的閾值，則 拒絕或拆單

**公式**：
```
Predicted_Slippage = f(Order_Volume, Order_Book_Depth, Market_Liquidity)
```

#### 2. 市場脆弱性指標

**Cost Per Tick 計算**：
- 衡量當前市場價格變動 1 個 Tick 需要消耗的總流動性
- 如果 Cost_Per_Tick < 閾值（市場極度脆弱），則 減少倉位或拆分訂單

**公式**：
```
Cost_Per_Tick = Volume_Trade / Price_Change_Ticks
```

**判斷規則**：
- 如果 Cost_Per_Tick < 5000，則 市場脆弱，減少倉位 50%
- 如果 Cost_Per_Tick > 10000，則 市場流動性好，正常倉位

#### 3. 宏觀系統性風險檢查

**Basis 異常檢查**：
- 如果 Basis_Residual < -50（深度貼水），則 市場普遍悲觀，系統性風險 +0.4
- 如果 Basis_Residual > 50（高度溢價），則 市場極度樂觀，可能泡沫，系統性風險 +0.3

**跨市場 Beta 異常檢查**：
- 如果 S&P 大跌 但 台指期沒有同步反應（Beta_Residual > 0.05），則 風險錯位，系統性風險 +0.3

**VIX 檢查**：
- 如果 VIX_Zscore > 2.0，則 恐慌情緒高，系統性風險 + (VIX_Zscore × VIX_Risk_Beta)

**最終淨資產敞口計算**：
```
Systemic_Risk_Score = Basis_Risk + Beta_Risk + VIX_Risk
Suggested_Net_Exposure = max(0.0, min(1.0, 1.0 - Systemic_Risk_Score))
```

#### 4. 倉位調整邏輯

**多層次倉位調整**：
```
最終倉位 = 原始信號 × 宏觀敞口 × 脆弱性懲罰 × RL 個股乘數
```

**判斷規則**：
- 如果 市場脆弱（Cost_Per_Tick < 閾值），則 脆弱性懲罰 = 0.6（減少 40% 倉位）
- 如果 系統性風險高（Suggested_Net_Exposure < 0.5），則 宏觀敞口 = Suggested_Net_Exposure

### 二、執行效率監控

#### 1. 執行效率殘差（Execution Residual）

**計算邏輯**：
- 比較預測的滑價成本（TCA_Predicted）與實際發生的滑價成本（TCA_Actual）
- 如果 TCA_Actual > TCA_Predicted，則 RL 會懲罰並學習新的拆單參數

**公式**：
```
Execution_Residual = TCA_Actual - TCA_Predicted
```

**應用**：
- 將 Execution_Residual 作為低級 RL 代理人的懲罰信號
- 如果 Execution_Residual 持續為正，則 觸發「因子重構警報」

#### 2. 熔斷機制（Circuit Breaker）

**觸發條件**：
- 如果 過去 5 分鐘的 Sharpe < -0.5，則 觸發熔斷
- 如果 模型誤差（Residual）超過歷史標準差的 3 倍，則 觸發熔斷

**熔斷動作**：
- 取消所有未成交訂單
- 嘗試緊急平倉
- 系統進入靜默模式，等待人工介入

### 三、心理面與紀律

#### 1. 避免過度交易
- **規則**：如果 當日已執行交易次數 > 10 次，則 暫停新交易
- **邏輯**：避免情緒化交易，保持紀律

#### 2. 避免追高殺低
- **規則**：如果 F_Stat VWAP 偏離 > 3.0（Z-score），則 不追高
- **規則**：如果 F_Stat 微結構反轉訊號出現，則 不殺低

#### 3. 資金管理
- **規則**：單一標的倉位不超過總資金的 20%
- **規則**：總倉位不超過總資金的 80%（保留 20% 現金）
- **規則**：如果 系統性風險高（Suggested_Net_Exposure < 0.5），則 總倉位不超過總資金的 50%

---

## 實務操作步驟

### 一、開盤前準備（Pre-market）

#### 1. 數據初始化
- 檢查數據庫連線
- 確認 DailyPrice 表格存在
- 載入昨日收盤價

#### 2. 長線因子計算
- 執行 F_C（LAC 偏離度）計算
- 執行 F_S（市場風格、市場熵）計算
- 執行 F_D（主題動能）計算

#### 3. RL 校準
- 載入最新的 Beta 權重
- 執行盤前校準，檢查模型狀態

#### 4. 訂單簿緩存預熱
- 連線 API 獲取靜態五檔數據
- 預熱 AsyncIO 隊列

### 二、盤中操作（Intraday）

#### 1. 實時數據採集
- 啟動 subscriber 任務：訂閱 Tick 數據
- 啟動 processor 任務：計算實時因子（F_Stat, F_Exec）

#### 2. 信號生成
- 整合五因子結果
- 使用 RL 代理人產生交易信號
- 計算建議倉位大小

#### 3. 風控檢查
- 執行 TCA 預測
- 檢查市場脆弱性
- 檢查宏觀系統性風險
- 調整最終倉位

#### 4. 訂單執行
- 智能訂單拆分
- 逐筆下單
- 記錄審計日誌

#### 5. 實時監控
- 監控數據延遲（如果 > 100ms，發出警報）
- 監控模型誤差（如果超過 3 倍標準差，觸發熔斷）
- 監控 Sharpe Ratio（如果 < -0.5，觸發熔斷）

### 三、收盤後結算（Post-market）

#### 1. 績效計算
- 計算當日 Sharpe Ratio
- 計算實際 MDD
- 計算總 PnL

#### 2. 執行效率診斷
- 計算 Execution_Residual（TCA_Actual vs TCA_Predicted）
- 分析訂單拆分策略效果

#### 3. RL 歸因與學習
- 執行因子貢獻度分析
- 運行層級 RL 代理人，根據新的 Sharpe 和 Execution_Residual 輸出新的 Beta 和參數
- 將新的參數寫入數據庫，供隔日使用

#### 4. 數據歸檔
- 將所有實時數據和歸因結果寫入數據庫
- 作為下一次訓練和回測的基礎

---

## 實戰案例整理

### 案例一：籌碼集中獲利出貨

**情境**：
- F_C LAC_Deviation = 2.5（Z-score），股價遠高於平均成本
- F_S 極度樂觀情緒，資金大量流入
- F_Stat VWAP 偏離擴大，但量能開始萎縮

**判斷**：
- 雖然 F_S 和 F_Stat 看似偏多，但 F_C 顯示籌碼集中獲利
- 因子交叉項 (F_C × F_S) 顯示：高籌碼集中度 + 極度樂觀 = 主力準備出貨

**行動**：
- 不追高，反而考慮減碼或出場
- 如果持有，設定停利點在 LAC + 2.0 × Std

**結果**：後續股價從高點回檔 15%，驗證判斷正確

### 案例二：期現套利機會

**情境**：
- F_Exec Basis_Residual = -60（深度貼水）
- F_Exec 跨市場 Beta_Residual = 0.08（S&P 大跌但台指期沒反應）
- VIX_Zscore = 2.5（恐慌情緒高）

**判斷**：
- 系統性風險 Score = 0.4 + 0.3 + (2.5 × 0.1) = 0.95
- Suggested_Net_Exposure = 1.0 - 0.95 = 0.05（幾乎清倉）

**行動**：
- 立即降低整體槓桿率至最低
- 甚至轉為淨空頭（Leverage < 1.0）
- 等待 Basis 回歸正常後再進場

**結果**：後續台股大跌 8%，系統成功避險

### 案例三：微觀結構反轉

**情境**：
- F_Stat 多根小黑突然跳大紅（多頭攻擊訊號）
- F_Exec 期貨領先向上突破
- F_Stat 異常量能爆發（Volume_Ratio > 2.0）

**判斷**：
- 微觀因子強烈偏多
- 期貨領先確認方向
- 量能爆發確認趨勢啟動

**行動**：
- 進場做多
- 設定停損在進場價 - 2%
- 如果 F_Stat 出現反轉訊號（多根小紅跳大黑），立即出場

**結果**：當日獲利 3.5%，隔日繼續上漲

### 案例四：統計套利配對交易

**情境**：
- 兩個高度相關股票（A 和 B）的價差 Z-score = 2.3
- A 被錯殺，B 被高估
- F_Stat 兩個股票的微觀結構都正常

**判斷**：
- 價差異常，均值回歸機會
- 做多 A，做空 B

**行動**：
- 進場配對交易
- 設定停損：如果價差 Z-score 繼續擴大超過 3.0
- 設定出場：如果價差 Z-score 回歸到 0

**結果**：3 天後價差回歸，獲利 2.1%

---

## AI 延伸補強

### 一、高維因子交叉（AI 補充）

#### 1. 因子交叉項設計
- **目標**：自動發現 F_C × F_S × F_D × F_Stat × F_Exec 的非線性組合
- **方法**：使用 DNN / Transformer 架構，讓模型自己發現交叉關係
- **應用**：不再只靠「人腦設計規則」，而是讓模型自己長出「看不見的交叉 Alpha」

#### 2. 價格物理屬性（AI 補充）
- **一階導數（速度）**：價格變化率
- **二階導數（加速度）**：價格變化率的變化
- **熵（不確定度）**：價格波動的混亂程度
- **應用**：如果價格加速度與成交量變化不成比例，可能代表有看不見的力量（主力、機構）在推動

### 二、市場狀態偵測（AI 補充）

#### 1. Regime Detection Model
- **目標**：偵測市場的「肉眼看不見的階段狀態」
- **狀態類型**：
  - 趨勢（Trend）：單邊上漲或下跌
  - 震盪（Range）：區間整理
  - 狂潮（Frenzy）：極度波動
- **應用**：讓整套策略知道現在是：趨勢 / 震盪 / 狂潮，並調整策略參數

### 三、流動性傳染分析（AI 補充）

#### 1. Liquidity Contagion Engine
- **目標**：分析跨資產 / 跨市場的風險傳導
- **方法**：用圖論 + 網路分析找出關鍵節點
- **應用**：哪些節點一旦出事，會把整個系統一起拉下去

### 四、分點行為模型（AI 補充）

#### 1. Broker Behavior Engine
- **目標**：根據分點 / 經紀商歷史行為，推測主力特性
- **指紋特徵**：
  - 平均持倉週期（隔日沖 vs 長線佈局）
  - 成交均價偏離度（滑價能力）
  - 贏家/輸家比率（買入後 5 日內上漲機率）
- **應用**：預測主力下一步可能怎麼做

### 五、時間同步與審計（AI 補充）

#### 1. NTP 時間同步
- **目標**：確保系統時間與交易所官方時間同步
- **方法**：使用專業的 NTP 服務，時間戳對齊到微秒級網格
- **應用**：避免期現套利時的時間戳偏差導致錯誤信號

#### 2. 審計日誌
- **目標**：所有下單、撤單、成交，以及 RL 調整 Beta 的理由，都必須以不可篡改的形式寫入數據庫
- **欄位**：時間戳、版本號、調整理由、is_real_trade、rl_version_id
- **應用**：確保回測時可以精確重現哪一天的 RL 模型版本做出了哪個決策

---

## J-GOD 系統可吸收的規則

### 一、因子計算規則

#### 1. F_C（籌碼因子）計算規則
```
IF 數據不足（< 60 日）
THEN 返回 None，不計算因子

計算 TP = (High + Low + Close) / 3
計算 Cost_Weighted_Volume = TP × Volume
計算 LAC = Sum(Cost_Weighted_Volume) / Sum(Volume) [60 日窗口]
計算 LAC_Deviation = Close_Price - LAC
計算 FC_LAC_Zscore = (LAC_Deviation - Mean) / Std [252 日窗口]

IF FC_LAC_Zscore > 2.0
THEN 籌碼集中獲利，出貨風險高

IF FC_LAC_Zscore < -2.0
THEN 籌碼集中套牢，技術性反彈或低吸機會
```

#### 2. F_Stat（微觀因子）計算規則
```
計算 VWAP_Deviation = (Price - VWAP) / VWAP
計算 Volume_Ratio = Current_Volume / Average_Volume [5-20 筆窗口]
計算 Order_Imbalance = Buy_Size - Sell_Size
計算 Spread = Ask_Price - Bid_Price

IF VWAP_Deviation > 0.02 且 持續擴大
THEN 多方主導

IF Volume_Ratio > 2.0
THEN 異常量能爆發，趨勢啟動或反轉

IF Order_Imbalance > 0 且 持續擴大
THEN 下方撐，偏多

IF Spread 收斂
THEN 越來越多人想進場，偏多
```

#### 3. F_Exec（跨市場因子）計算規則
```
計算 Basis = Futures_Price - Index_Price
計算 Basis_Residual = Basis - Average_Basis [120 筆窗口]
計算 Beta = TW_Futures / SP_Futures
計算 Beta_Residual = Beta - Average_Beta [60 筆窗口]

IF Basis_Residual < -50
THEN 深度貼水，市場恐慌，系統性風險高

IF 期貨先向上突破 且 現股還沒動
THEN 現股後續會漲（70% 機率）

IF Beta_Residual > 0.05
THEN S&P 大跌但台股沒反應，風險錯位
```

### 二、風控規則

#### 1. 交易成本預測規則
```
計算 Predicted_Slippage = f(Order_Volume, Order_Book_Depth, Market_Liquidity)

IF Predicted_Slippage > Max_Slippage_Tolerance (0.05%)
THEN 拒絕訂單 或 拆分訂單
```

#### 2. 市場脆弱性規則
```
計算 Cost_Per_Tick = Volume_Trade / Price_Change_Ticks

IF Cost_Per_Tick < Fragility_Threshold (5000)
THEN 市場脆弱，減少倉位 50%
```

#### 3. 宏觀系統性風險規則
```
Systemic_Risk_Score = 0.0

IF Basis_Residual < -50
THEN Systemic_Risk_Score += 0.4

IF Beta_Residual > 0.05
THEN Systemic_Risk_Score += 0.3

Systemic_Risk_Score += (VIX_Zscore × VIX_Risk_Beta)

Suggested_Net_Exposure = max(0.0, min(1.0, 1.0 - Systemic_Risk_Score))

IF Suggested_Net_Exposure < 0.5
THEN 降低整體槓桿率至最低，甚至轉為淨空頭
```

#### 4. 熔斷規則
```
IF 過去 5 分鐘的 Sharpe < -0.5
THEN 觸發熔斷：取消所有訂單，嘗試緊急平倉

IF 模型誤差（Residual）> 歷史標準差的 3 倍
THEN 觸發熔斷：取消所有訂單，嘗試緊急平倉
```

### 三、執行規則

#### 1. 訂單拆分規則
```
計算 num_slices = max(1, total_volume // max_single_order)
計算 slice_volume = total_volume // num_slices

IF 市場脆弱（Cost_Per_Tick < 閾值）
THEN 增加 num_slices，減少 slice_volume
```

#### 2. 倉位調整規則
```
最終倉位 = 原始信號 × 宏觀敞口 × 脆弱性懲罰 × RL 個股乘數

IF 市場脆弱
THEN 脆弱性懲罰 = 0.6（減少 40% 倉位）

IF 系統性風險高
THEN 宏觀敞口 = Suggested_Net_Exposure
```

### 四、RL 學習規則

#### 1. 高級代理人（Supervisory Agent）規則
```
State = [VIX_Zscore, Market_Entropy, Sharpe_30D, Execution_Residual]
Action = [Beta_FC, Beta_FS, Beta_FD, Net_Exposure]

Reward = Sharpe_30D × 10 - abs(Execution_Residual) × 1000

IF Reward 持續為負
THEN 調整 Beta 權重，降低表現差的因子權重

IF 某個因子的 Beta 持續接近 0
THEN 觸發「因子重構警報」
```

#### 2. 低級代理人（Sub-Agent）規則
```
State = [F_C_Zscore, F_S_Zscore, F_D_Zscore, Cost_Per_Tick]
Action = [Position_Multiplier, Slicing_Granularity]

Reward = -abs(Execution_Residual)

IF Execution_Residual 持續為正
THEN 調整 Slicing_Granularity，優化拆單策略
```

### 五、數據處理規則

#### 1. 數據清洗規則
```
IF 數據時間戳 >= 當前日期
THEN 拒絕處理（防範 Look-Ahead Bias）

IF 數據缺失 > 10%
THEN 標記為異常，不參與計算

應用複權處理：Price_Adjusted = Price × Adj_Factor
```

#### 2. 時間同步規則
```
所有輸入數據在計算前，必須被插值或四捨五入到最近的微秒級網格

IF 時間戳偏差 > 100ms
THEN 發出警報，暫停計算
```

---

## 總結

本文件提供了 J-GOD 股神作戰系統從 Citadel 和 Medallion 等級的量化交易系統設計藍圖。透過五因子模型、強化學習自主演化機制、預測性風控與智能執行，建立一個具備工業級韌性的 AI 驅動交易系統。

**核心價值**：
1. **結構化 Alpha**：F_C, F_S, F_D, F_Stat, F_Exec 五因子模型
2. **高頻 Alpha**：實時 RCNC、推測撤單率、經紀商行為指紋
3. **預測性風控**：Citadel 風格的 TCA 預測和市場脆弱性調整
4. **自主演化核心**：層級 RL 和 Meta-Learning 理論指導
5. **工程韌性**：NTP 時間同步、熔斷機制、API 狀態機與指數退避重試、審計日誌

**下一步行動**：
1. 階段 I：數據庫與 ORM 框架
2. 階段 II：數據採集與因子計算
3. 階段 III：長線引擎核心 Alpha 計算
4. 階段 IV：情緒因子與宏觀風險信號
5. 階段 V：層級 RL 系統設計
6. 階段 VI：預測性風控與智能訂單執行

---

**文件版本**：v1.0  
**建立日期**：2025-01-XX  
**適用系統**：J-GOD 股神作戰系統

