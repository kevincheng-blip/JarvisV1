# 邏輯版操作說明書 × J-GOD 系統對映關係

> **整理日期**：2024-11-28  
> **來源文件**：`docs/邏輯版操作說明書.txt` / `docs/邏輯版操作說明書_AI知識庫版_v1.md`

---

## 📚 核心概念概述

「邏輯版操作說明書」定義了 J-GOD 系統的**「三層架構」**與**「六種交易模式」**，特別強調：
- 預測層：多時間框架 AI 大腦
- 策略層：六種用戶行為模式（Mode 1-6）
- 介面層：CEO 看盤室的螢幕分工
- 模式 2 的萬分之三風險控管機制
- 三重審查決策樹

---

## 🏗️ 三層架構 × J-GOD 系統對映

### 一、預測層：多時間框架 AI 大腦

**核心概念**：
- 對象：大盤 / 個股
- 頻率：超短（5s, 30s）、短（1m, 5m）、中（10m, 30m, 1h）、日（EOD）
- 輸出：Direction, 目標價, Confidence, 預期波動, 短線反轉價位

**J-GOD 系統對映**：

| 系統模組 | 對應功能 | 狀態 |
|---------|---------|------|
| （規劃中）`prediction/multi_timeframe_engine.py` | 多時間框架預測引擎 | 待實作 |
| （規劃中）`prediction/prediction_output.py` | 標準化預測輸出（Direction, Magnitude, Confidence, Risk_Level） | 待實作 |
| `factor_engine/signal_factor.py` | F_Signal 因子（可作為預測輸入） | ✅ 已實作（Step 7） |
| `factor_engine/inertia_factor.py` | F_Inertia 因子（長期慣性預測） | ✅ 已實作（Step 6） |
| `factor_engine/capital_flow_factor.py` | F_C 因子（資金流預測） | ✅ 已實作 |

**預測輸出結構示例**：
```python
@dataclass
class PredictionOutput:
    timeframe: str  # "5s", "1m", "daily"
    direction: str  # "Long", "Short", "Neutral"
    target_price: float
    confidence: float  # 0-100%
    expected_volatility: float
    reversal_price: Optional[float]  # 大盤當沖額外
```

---

### 二、策略層：六種「人類玩法」模式

**核心概念**：
- Mode 1: 大盤當沖，多空來回刷
- Mode 2: 大盤當沖，只做多
- Mode 3: 大盤當沖，只做空
- Mode 4: 個股當沖，TOP 300 排序
- Mode 5: 只做漲的個股（EOD + 盤中一致）
- Mode 6: 只做跌的個股（EOD + 盤中一致）

**J-GOD 系統對映**：

| 交易模式 | 對應模組 | 狀態 |
|---------|---------|------|
| **Mode 1** | （規劃中）`strategy/mode1_swing_trading.py` | 待實作 |
| **Mode 2** | （規劃中）`strategy/mode2_pure_long.py` + `strategy/three_tier_review.py` | 待實作 |
| **Mode 3** | （規劃中）`strategy/mode3_pure_short.py` | 待實作 |
| **Mode 4** | （規劃中）`strategy/mode4_top300_sorter.py` | 待實作 |
| **Mode 5** | （規劃中）`strategy/mode5_confirmed_long.py` | 待實作 |
| **Mode 6** | （規劃中）`strategy/mode6_confirmed_short.py` | 待實作 |

**決策篩選器基類**：
```python
class StrategyMode(Protocol):
    def should_enter(self, prediction: PredictionOutput) -> bool:
        """判斷是否應該進場"""
        ...
    
    def should_exit(self, position: Position, prediction: PredictionOutput) -> bool:
        """判斷是否應該出場"""
        ...
```

---

### 三、介面層：CEO 的看盤室

**核心概念**：
- 螢幕 A：純粹用來「出手」的主控台
- 螢幕 B：用來「看系統自己好不好」的監控台

**J-GOD 系統對映**：

| 螢幕區域 | 對應模組 | 狀態 |
|---------|---------|------|
| **螢幕 A（主控台）** | `jgod/war_room/war_room_app.py` | ✅ 已實作（需擴充） |
| - 即時訊號（Mode 1/2/3/5/6） | （規劃中）`ui/realtime_signal_panel.py` | 待實作 |
| - 當前部位、損益 | （規劃中）`ui/position_panel.py` | 待實作 |
| - 萬分之三警戒提示 | （規劃中）`ui/risk_alert_panel.py` | 待實作 |
| **螢幕 B（監控台）** | （規劃中）`ui/monitor_dashboard.py` | 待實作 |
| - 預測失準排行榜 | （規劃中）`diagnostic/prediction_accuracy_ranking.py` | 待實作 |
| - 模型健康度 | `analysis/performance_analyzer.py` | ✅ 已實作（Step 8） |
| - TOP 300 清單 | （規劃中）`ui/top300_list.py` | 待實作 |
| - 收盤後檢討 | `pipeline/walk_forward_simulator.py` | ✅ 已實作（Step 7） |

---

## 🎯 模式 2：萬分之三機制 × J-GOD 系統對映

### 核心邏輯

**關鍵規則**：
- 萬分之三看的不是「我的成本 vs 現在價位」，而是「實際市場走到哪裡 vs 當初預測的終點」
- 當偏離達到萬分之三，系統會啟動「三重審查決策樹」

**J-GOD 系統對映**：

| 邏輯層級 | 對應模組 | 實施方式 |
|---------|---------|---------|
| **步驟 1：定義預測終點** | （規劃中）`strategy/mode2_config.py` | 每日開盤時設定今日預測終點、進場點 |
| **步驟 2：正常波動處理** | （規劃中）`strategy/mode2_normal_volatility.py` | 萬分之二以內 → 綠燈續抱 |
| **步驟 3：萬分之三觸發** | （規劃中）`strategy/three_tier_review.py` | 三重審查決策樹 |

---

### 三重審查決策樹（Three-Tier Review Decision Tree）

**核心概念**：
1. 優先檢查中短線趨勢是否已經崩壞，以決定是否應該立即止損
2. 只有在中短線趨勢仍維持一致看多時，AI 才被允許在萬分之四這條絕對底線之前，於嚴格監控下選擇續抱
3. 所有觸及臨界點的決策，將一律進入「強制虛擬模擬與事後比對」

**J-GOD 系統對映**：

| 決策樹層級 | 對應模組 | 實施邏輯 |
|-----------|---------|---------|
| **第一層：中短線共識檢查** | （規劃中）`strategy/three_tier_review.py::check_consensus()` | 檢查 5m/10m/30m 預測方向、Confidence |
| **情況 A：中短線翻空** | （規劃中）`strategy/mode2_exit_on_flip.py` | 建議止損、標記失準事件 |
| **情況 B：中短線仍看多** | （規劃中）`strategy/mode2_hold_with_risk.py` | B-1 保守派 / B-2 進取派選擇 |
| **情況 C：折衷上限** | （規劃中）`strategy/mode2_max_hold.py` | 萬分之三 → 開會，萬分之四 → 強制出場 |
| **強制虛擬模擬** | （規劃中）`simulation/shadow_trading.py` | 所有臨界點決策進入虛擬帳戶比對 |

**三重審查決策樹實作示例**：
```python
class ThreeTierReviewDecisionTree:
    def review(self, deviation_ratio: float, prediction: PredictionOutput) -> Decision:
        """
        當偏離達到萬分之三時，啟動三重審查。
        
        Args:
            deviation_ratio: 偏離預測終點的比例（例如 0.0003 = 萬分之三）
            prediction: 當前預測輸出
        
        Returns:
            Decision: 止損、續抱、或強制出場
        """
        if deviation_ratio >= 0.0004:  # 萬分之四
            return Decision.FORCE_EXIT
        
        if deviation_ratio >= 0.0003:  # 萬分之三
            # 第一層：檢查中短線共識
            consensus = self._check_consensus(prediction)
            
            if consensus.flipped:
                # 情況 A：中短線翻空 → 止損
                return Decision.STOP_LOSS
            
            elif consensus.still_long:
                # 情況 B：中短線仍看多 → 允許續抱一次
                return Decision.HOLD_WITH_RISK
        
        elif deviation_ratio >= 0.0002:  # 萬分之二
            # 橘燈警告
            return Decision.WARNING
        
        else:
            # 正常波動，續抱
            return Decision.HOLD_NORMAL
```

---

## 📊 六種交易模式的決策邏輯對映

### Mode 1：台期指當沖 - 趨勢反轉刷單

**邏輯目標**：最大化捕捉 Direction 轉折

**J-GOD 系統對映**：

| 動作 | 觸發條件 | 對應模組 |
|------|---------|---------|
| 買多 | T-Intraday(5s) 預測從 Short/Neutral → Long | （規劃中）`strategy/mode1_swing_trading.py::enter_long()` |
| 平倉/轉空 | T-Intraday(5s) 預測從 Long → Short/Neutral | （規劃中）`strategy/mode1_swing_trading.py::exit_and_short()` |

**特點**：需要極低的延遲和極高的交易速度

---

### Mode 2：台期指當沖 - 純買多鎖利

**邏輯目標**：鎖定 0.03% 微薄利潤，絕對不賠

**J-GOD 系統對映**：

| 階段 | 邏輯 | 對應模組 |
|------|------|---------|
| **進場** | T-Daily 為 Long AND T-Intraday(1m/5m) 為 Long 且 Confidence > 75% | （規劃中）`strategy/mode2_pure_long.py::should_enter()` |
| **出場（獲利）** | 達到 0.03% 報酬時立即平倉 | （規劃中）`strategy/mode2_pure_long.py::take_profit()` |
| **出場（止損）** | 預測方向轉變為 Short 或累積損失超過止損線 | （規劃中）`strategy/mode2_pure_long.py::stop_loss()` |
| **萬分之三檢查** | 觸發三重審查決策樹 | `strategy/three_tier_review.py` |

---

### Mode 3：台期指當沖 - 純買空鎖利

**邏輯目標**：與 Mode 2 邏輯對稱，只做空

**J-GOD 系統對映**：

| 階段 | 邏輯 | 對應模組 |
|------|------|---------|
| **進場** | T-Daily 為 Short AND T-Intraday(1m/5m) 為 Short 且 Confidence > 75% | （規劃中）`strategy/mode3_pure_short.py::should_enter()` |
| **出場（獲利）** | 達到 0.03% 報酬時立即平倉 | （規劃中）`strategy/mode3_pure_short.py::take_profit()` |
| **出場（止損）** | 預測方向轉變為 Long 或累積損失超過止損線 | （規劃中）`strategy/mode3_pure_short.py::stop_loss()` |

---

### Mode 4：個股當沖 - TOP 300 篩選與排序

**邏輯目標**：產生隔日最可能漲跌的 300 支股票清單

**J-GOD 系統對映**：

| 功能 | 排序邏輯 | 對應模組 |
|------|---------|---------|
| **TOP 300 排序** | 1. Confidence（機率評分）越高越前<br>2. Magnitude（漲跌幅，漲停/跌停優先）<br>3. 股價（Price）越高越前 | （規劃中）`strategy/mode4_top300_sorter.py` |

**實施示例**：
```python
class Top300Sorter:
    def sort_stocks(self, predictions: List[PredictionOutput]) -> List[str]:
        """按三層排序規則產出 TOP 300 清單"""
        sorted_stocks = sorted(
            predictions,
            key=lambda p: (
                -p.confidence,  # Confidence 越高越前
                -p.magnitude,   # Magnitude 越高越前（漲停優先）
                -p.price        # 股價越高越前
            )
        )
        return [p.symbol for p in sorted_stocks[:300]]
```

---

### Mode 5/6：個股當沖 - 漲跌訊號鎖定（Confirmation）

**邏輯目標**：只交易「被證實」的個股（EOD + 盤中雙重確認）

**J-GOD 系統對映**：

| 模式 | 確認條件 | 對應模組 |
|------|---------|---------|
| **Mode 5（只買漲）** | 昨日 EOD 預測為 Long AND 當日 T-Intraday(1m) 預測持續為 Long | （規劃中）`strategy/mode5_confirmed_long.py` |
| **Mode 6（只買跌）** | 昨日 EOD 預測為 Short AND 當日 T-Intraday(1m) 預測持續為 Short | （規劃中）`strategy/mode6_confirmed_short.py` |

**確認邏輯示例**：
```python
class ConfirmedSignalFilter:
    def is_confirmed(self, symbol: str, eod_prediction: PredictionOutput, intraday_prediction: PredictionOutput) -> bool:
        """檢查是否具備雙重預測確認"""
        if eod_prediction.direction == "Long" and intraday_prediction.direction == "Long":
            return True  # Mode 5 確認
        elif eod_prediction.direction == "Short" and intraday_prediction.direction == "Short":
            return True  # Mode 6 確認
        return False
```

---

## 🖥️ 系統介面（Dashboard）對映

### 整合的「AI 預測儀表板」

**核心概念**：整合為單一儀表板，分區顯示即時、趨勢、目標、個股四種資訊

**J-GOD 系統對映**：

| 介面區域 | 顯示內容 | 對應模組 | 狀態 |
|---------|---------|---------|------|
| **1. 即時預測修正區** | T-Intraday (5s, 30s, 1m) 預測趨勢圖、Direction, Confidence, Risk_Level | （規劃中）`ui/realtime_prediction_panel.py` | 待實作 |
| **2. 目標/累積淨值區** | 預設目標 vs 當前預測目標、Mode 2/3 累積淨值與 PnL | （規劃中）`ui/target_pnl_panel.py` | 待實作 |
| **3. 隔日個股清單區** | Mode 4 產出的 TOP 300 漲/跌股清單 | （規劃中）`ui/top300_list_panel.py` | 待實作 |
| **4. 訊號共識篩選器** | Mode 5/6 的已確認股票清單（EOD + Intraday 雙重確認） | （規劃中）`ui/confirmed_signal_panel.py` | 待實作 |

**現有 UI 基礎**：
- `jgod/war_room/war_room_app.py`：Streamlit Web UI（可擴充為儀表板）

---

## 📈 PerformanceAnalyzer 擴展建議

**核心指標擴充**：

| 指標 | 用途 | 對應模式 |
|------|------|---------|
| **Trade Count** | 評估刷單量 | Mode 1/2/3 |
| **Average Trade PnL** | 驗證 0.03% 鎖利是否有效 | Mode 2/3 |
| **Win Rate** | 評估模式命中率 | 所有模式 |
| **Max Deviation** | 記錄最大偏離預測終點的比例 | Mode 2（萬分之三機制） |

**擴展示例**：
```python
@dataclass
class Mode2Metrics(PerformanceMetrics):
    """Mode 2 專屬績效指標"""
    trade_count: int = 0
    average_trade_pnl: float = 0.0
    max_deviation_from_target: float = 0.0  # 最大偏離預測終點的比例
    three_tier_review_triggered_count: int = 0  # 觸發三重審查的次數
    force_exit_count: int = 0  # 萬分之四強制出場次數
```

---

## 🔄 與其他系統模組的整合

### 與「滾動式分析」的整合

| 滾動式分析概念 | 邏輯版操作說明書對應 | 整合方式 |
|--------------|-------------------|---------|
| **Phase 1：規則＋因子 Walk-Forward** | 六種交易模式（規則層） | Mode 1-6 作為 Walk-Forward 的策略規則 |
| **Phase 2：引入 RL** | 多時間框架預測引擎（可升級為 RL） | 預測層可用 RL 模型取代 |
| **強制虛擬模擬** | 模式 2 的虛擬帳戶比對 | 所有臨界點決策進入虛擬模擬 |

### 與「萬物修復法則」的整合

| 修復層面 | 邏輯版操作說明書對應 | 整合方式 |
|---------|-------------------|---------|
| **價格與空間的修復** | 模式 1 的反轉偵測、模式 2 的萬分之三機制 | 當偏離達到閾值時，觸發修復機制 |
| **時間與週期的修復** | 多時間框架預測引擎 | 檢查不同時間框架的一致性 |
| **系統與模型的修復** | 預測失準排行榜、模型健康度監控 | 螢幕 B 的監控功能 |
| **情緒與行為的修復** | 三重審查決策樹、虛擬模擬學習 | AI 自我批判與優化 |

---

## 🎯 實施優先級建議

### 第一階段（高優先級）

| 模組 | 優先級 | 理由 |
|------|--------|------|
| `strategy/mode2_pure_long.py` | 🔴 高 | 模式 2 是核心邏輯，包含萬分之三機制 |
| `strategy/three_tier_review.py` | 🔴 高 | 三重審查決策樹是模式 2 的核心 |
| `prediction/multi_timeframe_engine.py` | 🔴 高 | 所有模式的基礎 |
| `ui/realtime_signal_panel.py` | 🟡 中 | 螢幕 A 的主控台 |

### 第二階段（中優先級）

| 模組 | 優先級 | 理由 |
|------|--------|------|
| `strategy/mode1_swing_trading.py` | 🟡 中 | 模式 1 需要極低延遲 |
| `strategy/mode4_top300_sorter.py` | 🟡 中 | 個股排序邏輯 |
| `ui/monitor_dashboard.py` | 🟡 中 | 螢幕 B 監控台 |

### 第三階段（低優先級）

| 模組 | 優先級 | 理由 |
|------|--------|------|
| `strategy/mode3_pure_short.py` | 🟢 低 | 與 Mode 2 對稱，較簡單 |
| `strategy/mode5_confirmed_long.py` | 🟢 低 | 依賴 Mode 4 |
| `strategy/mode6_confirmed_short.py` | 🟢 低 | 依賴 Mode 4 |

---

## 💡 設計原則

在設計/調整任何策略模式時，都要問：

1. **這段程式碼對應哪一種「交易模式」？**
   - Mode 1（多空刷）？
   - Mode 2（只做多）？
   - Mode 4（TOP 300 排序）？

2. **它如何與「預測層」整合？**
   - 使用哪些時間框架的預測？
   - 需要什麼樣的 Confidence 門檻？

3. **它是否遵循「萬分之三機制」或類似風險控管？**
   - 是否有止損邏輯？
   - 是否有獲利鎖定機制？

---

*本文件作為 J-GOD 系統開發的核心指導原則，所有策略模式設計都應遵循「邏輯版操作說明書」的精神。*

